// Generated by CoffeeScript 1.12.7
(function() {
  var cRequest,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  cRequest = (function() {
    function cRequest() {
      this.change_request = bind(this.change_request, this);
      this.set_bindings = bind(this.set_bindings, this);
      this.load_requests = bind(this.load_requests, this);
      $.ajaxSetup({
        cache: false
      });
      this.load_requests();
      this.set_bindings();
      this.requests = [];
      this.string_send = '';
    }

    cRequest.prototype.load_requests = function() {
      return $.getJSON('/api/request/pending').always((function(_this) {
        return function(data) {
          var i, len, ref, request, results;
          if (data.status === 'OK' && (data != null ? data.data : void 0)) {
            _this.requests = data.data;
            ref = data.data;
            results = [];
            for (i = 0, len = ref.length; i < len; i++) {
              request = ref[i];
              results.push($('#req_choose').tmpl({
                id: request.req_id,
                description: request.req_description,
                date: moment(request.req_date).format('YYYY-MM-DD'),
                state: request.type_state_req_name
              }).appendTo(".request-results"));
            }
            return results;
          }
        };
      })(this));
    };

    cRequest.prototype.set_bindings = function() {
      $('#c_request').submit(this.change_request);
      return $(document).on('click', '.sel_req', (function(_this) {
        return function(e) {
          var _elem, elem, req_id, request;
          e.preventDefault();
          elem = $(e.currentTarget).attr('id');
          _elem = elem.split('-');
          req_id = "req_id=" + _elem[1];
          console.log(req_id);
          _this.string_send = "" + req_id;
          request = _.find(_this.requests, function(req) {
            return req.req_id = _elem[1];
          });
          console.log(request);
          return $("#req_choose").tmpl({
            id: request.req_id,
            description: request.req_description,
            date: moment(request.req_date).format('YYYY-MM-DD'),
            state: request.type_state_req_name
          }).appendTo(".request-selected");
        };
      })(this));
    };

    cRequest.prototype.change_request = function(e) {
      var opts;
      e.preventDefault();
      opts = $(e.currentTarget).serialize();
      this.string_send = this.string_send + "&" + opts;
      console.log(this.string_send);
      return $.post('/api/request/change', this.string_send, function(data) {
        console.log(data);
        if (data.status === 'OK' && (data.data != null)) {
          return alert(data.data);
        } else {
          console.log(data);
          return alert(data.data);
        }
      });
    };

    return cRequest;

  })();

  window.cRequest = cRequest;

}).call(this);
